FROM amazonlinux:2
# This final build stage is generated by the Wdesk SDK.
# Please see the README for more information

# Update uid and guid of nobody to be 65534 and not the image's default of 99
# This is done to make the uid and guid match the uid/guid specified in the runAsUser when the
# container is run in k8s
RUN sed -i 's/nobody:x:99:99/nobody:x:65534:65534/g' /etc/passwd
RUN sed -i 's/nobody:x:99:/nobody:x:65534:/g' /etc/group

# Add the official nginx.org repo to pull from
# base64-encoded key from http://nginx.org/packages/keys/nginx_signing.key
ENV NGINX_REPO_KEY=LS0tLS1CRUdJTiBQR1AgUFVCTElDIEtFWSBCTE9DSy0tLS0tClZlcnNpb246IEdudVBHIHYyLjAuMjIgKEdOVS9MaW51eCkKCm1RRU5CRTVPTW1JQkNBRCtGUFlLR3JpR0dmN05xd0tmV0M4M2NCVjAxZ2FiZ1ZXUW1aYk1jRnplVytoTXNneEgKVzZpaW1EMFJzZlo5b0ViZkpDUEcwQ1JTWjdwcHE1cEthbVlzMitFSjhRMnlzT0ZISHdwR3JBMkM4enlOQXM0SQpReG5aWkliRVRnY1N3RnREdW4wWGlxUHdQWmd5dVhWbTlQQWJMWlJiZkJ6bTh3Ui8zU1d5Z3FaQkJMZFFrNVRFCmZEUitFbnkvTTFSVlI0eENsRUNPTkY5VUJCMmVqRmRJMUxENDVBUGJQMmhzTi9waUZCeVUxdDd5SzJncEZ5UnQKOTdXekdIbjlNVjUvVEw3QW1SUE00cGNyM0phY210Q254WGVDWjhuTHFlZG9TdUhGdWh3eURubEFidThJMTZPNQpYUnJmemhySFJKRk0xSm5JaUdtelppNnpCdkgwSXRmeVg2dHRBQkVCQUFHMEtXNW5hVzU0SUhOcFoyNXBibWNnCmEyVjVJRHh6YVdkdWFXNW5MV3RsZVVCdVoybHVlQzVqYjIwK2lRRStCQk1CQWdBb0Foc0RCZ3NKQ0FjREFnWVYKQ0FJSkNnc0VGZ0lEQVFJZUFRSVhnQVVDVjJLMStBVUpHQjRmUVFBS0NSQ3I5YjJDZTltL1lsb2FCLzlYR3JvbAprb2NtN2wvdHNWamFCUUN0ZVhLdXdzbTRYaEN1QVE2WUF3QTFMMVVoZUdPRy9hYTJ4SnZyWEU4WDMydGdjVGpyCktvWW9YV2NkeGFGamxYR1R0NmpWODVxUmd1VXp2TU94eFNFTTJEbjExNWV0TjlwaVBsMFp6KzRya3g4KzJ2SkcKRitlTWxydVBYZy96ZDg4TnZ5THE1Z0dIRXNGUkJNVnVmWW1IdE5mY3A0b2tDMWtsV2lSSVJTZHA0UVkxd2RyTgoxTysvb0NUbDhCenk2aGNIakxJcTNhb3VtY0x4TWp0Qm9jbGMvNU9UaW9MRHdTRGZWeDdyV3lmUmhjQnpWYndECm9lL1BEMDhBb0FBNmZ4WHZXalN4eStkR2hFYVhvVEhqa0Niei9sNk54ckszSkZ5YXVEZ1U0SzRNeXRzWjFIRGkKTWdNVzhoWlh4c3pvSUNUVGlRRWNCQkFCQWdBR0JRSk9Ua2VsQUFvSkVLWlAxYkY2Mnptbzc5b0gvMVhEYjI5UwpZdFdwK01USlRQRkV3bFdSaXlSdURYeTN3QmQvQnB3QlJJV2ZXek1zMWduQ2pOamswRVZCVkdhMmdydnk5SnR4CkpLTWQ2bC9QV1hWdWNTdCtVLytHTzhyQmt3MTRTZGhxeGFTMmwxNHY2Z3lNZVVyU2JZM1hmVG9HZndIQzRzYS8KVGhuOFg0akZhUTJYTjVkQUl6SkdVMXM1SkEwdGpFelV3Q25tcktteU1sWFphb1FWcm1PUkdqQ3VIMEkwYUFGawpSUzBVdG5COUhQcHhoR1ZiczI0eFhaUW5aRE5iVVFldWxGeFM0dVAzT0xEQkFlQ0hsK3Y0dC91b3RJYWQ4djZKClNPOTN2YzFldklqZTZsZ3VFODFISG1Kbjlub3hQSXR2T3ZTTWIyeVBzRThtSDRjSkhSVEZOU0VoUFc2Z2htbGYKV2E5WndpVlg1aWd4Y3ZhSVJnUVFFUUlBQmdVQ1RrNWIwZ0FLQ1JEczhPa0xMQmNnZzFHK0FLQ25hY0xiLytXNgpjZmxpclVJRXhnWmRVSnFvb2dDZU5QVndYaUhFSVZxaXRoQU0xcGRZL2djYVFabUlSZ1FRRVFJQUJnVUNUazVmCllRQUtDUkNwTjJFNXBTVEZQbk5XQUo5Z1VvenlpUys5amYyckp2cW1KU2VXdUNnVlJ3Q2NDVUZoWFJDcFFPMlkKVmEzbDNXdUIrcmdLanNRPQo9RVdXSQotLS0tLUVORCBQR1AgUFVCTElDIEtFWSBCTE9DSy0tLS0tCg==
RUN echo $NGINX_REPO_KEY | base64 --decode > /tmp/nginx_signing.key
RUN rpm --import /tmp/nginx_signing.key && \
    yum install -y yum-utils && \
    yum-config-manager --add-repo=http://nginx.org/packages/mainline/centos/7/x86_64/ && \
    yum remove -y yum-utils && \
    yum install -y \
    # `gettext` is needed to run `envsubst` in `start_nginx.sh`
    gettext \
    nginx \
    tar && \
    rm -rf /var/cache/yum

ENV HARBOUR_CHECK_TIMEOUT 5s
ENV HARBOUR_CHECK_INTERVAL 60s
ENV HARBOUR_CHECK_URL http://%s:80/health

COPY --chown=0:0 config/wdesk_sdk/nginx.conf /etc/nginx/conf.d/vhost.conf
COPY --chown=0:0 tool/wdesk_sdk/inject_environment_variables.sh /
COPY --chown=0:0 tool/wdesk_sdk/start_nginx.sh /
COPY --chown=0:0 config/ /config/
COPY --from=build /build/smithy /build/smithy

ARG BUILD_ID
RUN yum update -y && \
    yum upgrade -y && \
    yum autoremove -y && \
    yum clean all && \
    rm -rf /var/cache/yum

# Prevent the nginx "hello world" page from being the default vhost
RUN rm /etc/nginx/conf.d/default.conf && \
    sed -i 's/ default_server//g' /etc/nginx/nginx.conf && \
    sed -i 's/server_name  _/server_name default.example.com/g' /etc/nginx/nginx.conf && \
    sed -i '4idaemon off;' /etc/nginx/nginx.conf && \
    mkdir -p /tmp/app && \
    mkdir -p /var/lib/nginx/tmp && \
    tar xzf $(find /build/smithy -name assets*.tar.gz) -C /tmp/app && \
    rm $(find /build/smithy -name assets*.tar.gz) && \
    chown -R nobody:nobody /var/log /var/lib/nginx /var/cache/nginx /etc/nginx /etc/nginx/conf.d /run /tmp/app
RUN setcap CAP_NET_BIND_SERVICE=+eip /usr/sbin/nginx
EXPOSE 80

RUN nginx -v

USER nobody
CMD ["/start_nginx.sh"]
