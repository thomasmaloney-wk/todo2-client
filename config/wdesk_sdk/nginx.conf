# This file is generated by the Wdesk SDK. Please see the README for more information.
# Do not create request logs.
access_log off;

# Don't send the nginx version number in error pages and Server header.
server_tokens off;

server {

    # This block handles public traffic from Harbour, including the index.html
    # which points at built JS assets on the CDN.
    listen 80 default_server;

    root /tmp/app;
    index index.html;

    # Get the value for the Content-Security-Policy header from the environment.
    set $csp "${APP_CONTENT_SECURITY_POLICY}";
    set $env_sts "${DISABLE_STRICT_TRANSPORT_SECURITY}";
    set $env_static_asset_prefix "${STATIC_ASSET_PREFIX}";

    # Determine the value for the Strict-Transport-Security header. If there is
    # a DISABLE_STRICT_TRANSPORT_SECURITY environment variable set, then don't
    # include the header; otherwise set it to a default value.
    set $sts_default 'max-age=31536000; includeSubDomains; preload';
    set $sts '';
    # If env DISABLE_STRICT_TRANSPORT_SECURITY is empty, set the value to default
    if ( $env_sts ~* "^$" ) {
        set $sts $sts_default;
    }

    set $static_asset_prefix '';
    # If env STATIC_ASSET_PREFIX is not empty, set the value
    if ( $env_static_asset_prefix ~* "^(?!\s*$).+" ) {
        set $static_asset_prefix "${STATIC_ASSET_PREFIX}";
    }

    # Update request to remove path based route prefix if present
    rewrite ^(?:\/[sS]\/[^\/]*)?(\/.*)$ $1 last;

    location / {
        # Attempt any given URI and serve index if it is not available. This
        # removes the need for segment routing.
        try_files $uri $uri/ /;
        add_header Cache-Control "max-age=0, no-cache, no-store, must-revalidate";
        add_header Expires 0;
        add_header Pragma no-cache;
        add_header Content-Security-Policy "$csp";
        add_header Strict-Transport-Security "$sts";
        # Disable content sniffing.
        add_header X-Content-Type-Options nosniff;
        # Instruct the browser not to render the page inside an frame or iframe to
        # avoid clickjacking.
        add_header X-Frame-Options SAMEORIGIN;
        # Forces XSS protection. This should be the default - but it may have been
        # disabled by the user. mode=block will prevent rendering of pages if a
        # potential XSS reflection, instead of sanitizing.
        add_header X-XSS-Protection "1; mode=block";
    }

    location = / {
        try_files /$static_asset_prefix/index.html /index.html;
        add_header Cache-Control "max-age=0, no-cache, no-store, must-revalidate";
        add_header Expires 0;
        add_header Pragma no-cache;
        add_header Content-Security-Policy "$csp";
        add_header Strict-Transport-Security "$sts";
        # Disable content sniffing.
        add_header X-Content-Type-Options nosniff;
        # Instruct the browser not to render the page inside an frame or iframe to
        # avoid clickjacking.
        add_header X-Frame-Options SAMEORIGIN;
        # Forces XSS protection. This should be the default - but it may have been
        # disabled by the user. mode=block will prevent rendering of pages if a
        # potential XSS reflection, instead of sanitizing.
        add_header X-XSS-Protection "1; mode=block";
    }

    location = /js/environment_settings.js {
        try_files /$static_asset_prefix/js/environment_settings.js /js/environment_settings.js;
        add_header Cache-Control "max-age=0, no-cache, no-store, must-revalidate";
        add_header Expires 0;
        add_header Pragma no-cache;
    }

    # Health check configuration for use by devops and rapid response tools.
    location = /health {
        add_header 'Access-Control-Allow-Origin' '*';
        add_header Content-Type application/json;
        add_header Cache-Control "max-age=0, no-cache, no-store, must-revalidate";
        add_header Expires 0;
        add_header Pragma no-cache;
        add_header Content-Security-Policy "$csp";
        add_header Strict-Transport-Security "$sts";
        add_header X-Content-Type-Options nosniff;
        add_header X-Frame-Options SAMEORIGIN;
        add_header X-XSS-Protection "1; mode=block";
        return 200 '{"status": "all is well"}';
    }

    # The following two locations return empty response for OAuth2 redirect uris.
    location = /oauth.html {
        add_header Content-Security-Policy "$csp";
        add_header Strict-Transport-Security "$sts";
        add_header X-Content-Type-Options nosniff;
        add_header X-Frame-Options SAMEORIGIN;
        add_header X-XSS-Protection "1; mode=block";
        return 200 'ok';
    }

    location /oauth2redirect {
        default_type text/html;
        add_header Content-Security-Policy "$csp";
        add_header Strict-Transport-Security "$sts";
        add_header X-Content-Type-Options nosniff;
        add_header X-Frame-Options SAMEORIGIN;
        add_header X-XSS-Protection "1; mode=block";
        return 200 'ok';
    }

    error_log stderr error;
}
